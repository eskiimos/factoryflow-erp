#!/bin/bash

# ๐ FactoryFlow ERP - ะกะบัะธะฟั ะฑััััะพะณะพ ัะฐะทะฒะตัััะฒะฐะฝะธั
# ะะฒัะพะผะฐัะธัะตัะบะพะต ัะฐะทะฒะตัััะฒะฐะฝะธะต ะฟะพะปะฝะพะน ERP ัะธััะตะผั ะฒ ะพะฑะปะฐะบะต

set -e

echo "๐ FactoryFlow ERP - ะะฒัะพะผะฐัะธัะตัะบะพะต ัะฐะทะฒะตัััะฒะฐะฝะธะต"
echo "=================================================="

# ะัะพะฒะตัะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
echo "๐ ะัะพะฒะตัะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."
command -v node >/dev/null 2>&1 || { echo "โ Node.js ะฝะต ัััะฐะฝะพะฒะปะตะฝ"; exit 1; }
command -v npm >/dev/null 2>&1 || { echo "โ npm ะฝะต ัััะฐะฝะพะฒะปะตะฝ"; exit 1; }
command -v git >/dev/null 2>&1 || { echo "โ Git ะฝะต ัััะฐะฝะพะฒะปะตะฝ"; exit 1; }

echo "โ ะัะต ะทะฐะฒะธัะธะผะพััะธ ัััะฐะฝะพะฒะปะตะฝั"

# ะฃััะฐะฝะพะฒะบะฐ ะฟะฐะบะตัะพะฒ
echo "๐ฆ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."
npm install

# ะัะพะฒะตัะบะฐ environment ัะฐะนะปะพะฒ
if [ ! -f .env ]; then
    echo "โ๏ธ ะกะพะทะดะฐะฝะธะต .env ัะฐะนะปะฐ..."
    cp .env.example .env
    echo "โ๏ธ  ะะะะะ: ะะฐัััะพะนัะต ะฟะตัะตะผะตะฝะฝัะต ะฒ .env ัะฐะนะปะต!"
fi

# ะะตะฝะตัะฐัะธั Prisma ะบะปะธะตะฝัะฐ
echo "๐ง ะะตะฝะตัะฐัะธั Prisma ะบะปะธะตะฝัะฐ..."
npx prisma generate

# ะัะพะฒะตัะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั
echo "๐๏ธ ะัะพะฒะตัะบะฐ ะฑะฐะทั ะดะฐะฝะฝัั..."
if npx prisma db push --accept-data-loss 2>/dev/null; then
    echo "โ ะะฐะทะฐ ะดะฐะฝะฝัั ะฟะพะดะบะปััะตะฝะฐ"
else
    echo "โ๏ธ  ะะฐะทะฐ ะดะฐะฝะฝัั ะฝะต ะฝะฐัััะพะตะฝะฐ. ะะฐัััะพะนัะต DATABASE_URL ะฒ .env"
fi

# ะกะฑะพัะบะฐ ะฟัะพะตะบัะฐ
echo "๐จ ะกะฑะพัะบะฐ ะฟัะพะตะบัะฐ..."
npm run build

# ะัะพะฒะตัะบะฐ ัะฐะฑะพัะพัะฟะพัะพะฑะฝะพััะธ
echo "๐งช ะขะตััะธัะพะฒะฐะฝะธะต API..."
npm run start &
SERVER_PID=$!
sleep 5

# ะัะพะฒะตัะบะฐ API ัะพัะผัะป
if curl -s http://localhost:3000/api/formulas >/dev/null; then
    echo "โ API ัะฐะฑะพัะฐะตั ะบะพััะตะบัะฝะพ"
else
    echo "โ๏ธ  API ะฝะตะดะพัััะฟะฝะพ"
fi

kill $SERVER_PID 2>/dev/null || true

echo ""
echo "๐ ะะะะะะะขะซะะะะะ ะะะะะะจะะะ!"
echo "=========================="
echo ""
echo "๐ ะงัะพ ะดะฐะปััะต:"
echo "1. ๐๏ธ  ะะฐัััะพะนัะต PostgreSQL ะฝะฐ https://console.neon.tech"
echo "2. โ๏ธ  ะะฑะฝะพะฒะธัะต DATABASE_URL ะฒ .env.local"
echo "3. ๐ ะะฐะทะฒะตัะฝะธัะต ะฝะฐ Vercel: vercel --prod"
echo "4. ๐ ะะฐะฟัััะธัะต ะผะธะณัะฐัะธะธ: npx prisma migrate deploy"
echo ""
echo "๐ ะะพะบะฐะปัะฝัะน ะทะฐะฟััะบ: npm run dev"
echo "๐ ะัะบัะพะนัะต: http://localhost:3000/test-formulas"
echo ""
echo "๐ ะะพะบัะผะตะฝัะฐัะธั: DEPLOY.md"
echo "๐ง ะกัะฐััั: DEPLOYMENT_STATUS.md"
echo ""
echo "โจ FactoryFlow ERP ะณะพัะพะฒ ะบ ะธัะฟะพะปัะทะพะฒะฐะฝะธั!"
