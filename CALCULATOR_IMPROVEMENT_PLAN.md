# План улучшения калькулятора заказов

## Текущее состояние
Калькулятор работает с простой формульной системой, но не учитывает сложную структуру изделий.

## Проблемы для шкафа-купе:
1. **Детализация по компонентам**: корпус, двери, полки, направляющие, ручки
2. **Материалы по зонам**: разные материалы для разных частей
3. **Раскрой и отходы**: учет потерь материала при раскрое
4. **Вариативность**: разные комплектации (2/3/4 двери, с зеркалами/без)

## План улучшений:

### 1. Система деталировки изделий (Components System)
```prisma
model ProductComponent {
  id            String @id @default(cuid())
  productId     String
  name          String  // "Корпус", "Дверь левая", "Полка"
  componentType String  // "MAIN", "OPTIONAL", "VARIANT"
  quantity      Float   // Количество данной детали в изделии
  
  // Формулы для расчета количества
  quantityFormula String? // "(height - 20) / 350" для полок
  
  // Материалы для данной детали
  materialUsages ComponentMaterialUsage[]
  workTypeUsages ComponentWorkTypeUsage[]
  
  product       Product @relation(fields: [productId], references: [id])
}

model ComponentMaterialUsage {
  id             String @id @default(cuid())
  componentId    String
  materialItemId String
  
  // Формула расчета материала для детали
  usageFormula   String  // "width * height / 1000000" для м²
  wasteFactor    Float @default(1.1) // Коэффициент отходов
  
  component      ProductComponent @relation(fields: [componentId], references: [id])
  materialItem   MaterialItem @relation(fields: [materialItemId], references: [id])
}
```

### 2. Улучшенная формульная система
- **Зависимые параметры**: высота полки зависит от высоты шкафа
- **Условная логика**: если есть зеркало, то другой материал двери
- **Многоуровневые расчеты**: сначала габариты, потом детали, потом материалы

### 3. Система раскроя материалов
```typescript
interface CuttingPlan {
  materialId: string
  sheetSize: { width: number; height: number }
  parts: CuttingPart[]
  wastePercentage: number
  sheetsRequired: number
}

interface CuttingPart {
  componentName: string
  width: number
  height: number
  quantity: number
  rotation: boolean // можно ли поворачивать
}
```

### 4. Калькулятор с детализацией

#### Пример для шкафа-купе:
```
Шкаф-купе 3-х дверный 2400x600x2200
├── Корпус
│   ├── Боковина левая: ЛДСП 18мм, 600x2200, 1 шт
│   ├── Боковина правая: ЛДСП 18мм, 600x2200, 1 шт  
│   ├── Крыша: ЛДСП 18мм, 2364x600, 1 шт
│   ├── Днище: ЛДСП 18мм, 2364x600, 1 шт
│   └── Задняя стенка: ДВП 3мм, 2400x2164, 1 шт
├── Двери (3 шт)
│   ├── Дверь 1: Зеркало 4мм, 798x2164, 1 шт
│   ├── Дверь 2: ЛДСП 18мм, 798x2164, 1 шт
│   └── Дверь 3: ЛДСП 18мм, 798x2164, 1 шт
├── Полки (Кол-во полок)
│   └── Полка: ЛДСП 18мм, 782x600, N шт
├── Фурнитура
│   ├── Направляющие: Comandor 2400мм, 2 шт
│   ├── Ролики: верхние 4шт + нижние 6шт
│   └── Ручки: врезные, 3 шт
└── Работы
    ├── Раскрой ЛДСП: X м² * 150₽/м²
    ├── Присадка: Y отверстий * 5₽/отв
    ├── Сборка корпуса: 3 часа * 800₽/час
    └── Навеска дверей: 1 час * 800₽/час
```

## Реализация:

### Этап 1: Расширение схемы БД
- Добавить таблицы компонентов и их материалов
- Улучшить формульную систему
- Добавить поддержку условий и зависимостей

### Этап 2: Калькулятор компонентов  
- Создать интерфейс для настройки деталей изделия
- Калькулятор раскроя листовых материалов
- Система учета отходов

### Этап 3: Улучшенный UI калькулятора
- Древовидная структура изделия
- Детализация по компонентам
- Визуализация раскроя

### Этап 4: Шаблоны сложных изделий
- Готовые шаблоны для мебели
- Параметрические модели
- Библиотека стандартных компонентов

## Вывод:
Нужна более сложная система, которая:
1. **Разбивает изделие на компоненты**
2. **Рассчитывает каждый компонент отдельно**  
3. **Учитывает раскрой и отходы**
4. **Поддерживает вариативность комплектаций**
5. **Дает подробную детализацию по материалам и работам**

Такой подход даст точные расчеты для сложной мебели и других изделий.
